---
title: "KableExtra buildingblock"
author: "Valerie Vossen"
date: "2023-04-26"
output: 
 html_document: default
draft: TRUE
---

# Overview

The main purpose of the kableExtra package is to simplify the process of creating tables with custom styles and formatting in R. With kableExtra, you can easily create and modify tables with more advanced features and layouts, such as merged cells, footnotes, and custom fonts. This can help make your tables more visually appealing and easier to read, which is especially useful when presenting data to others.

This building block will give you an example how to to further customize modelsummary output with kableExtra. We will build upon the building block about modelsummary (add link) and further customize the replicated regression table of Eiccholtz et al. (2010) we ended with. Modelsummary allowed for some nice customizations already, but the lay-out can be further improved best with KableExtra.


```{r warning = FALSE, message = FALSE}

# Load packages
library(modelsummary)
library(dplyr)
library(fixest)
library(stringr)
library(knitr)
library(kableExtra)

# Load data 

data_rent_100710 <- read.delim("https://github.com/tilburgsciencehub/website/blob/95dba729dfd05d6aadad7e61b35047eac882de1b/content/building-blocks/analyze-data/regressions/data_rent_100710.txt?raw=true")

data_rent <- data_rent_100710 %>%
  janitor::clean_names() #clean column names; for example, it converts all letters to lowercase

```

The next code chunks loads the final table of the Modelsummary buildingblock. Only some minor changes are made to allow for using the functions of kableExtra to its full potential. The title and note below the table are omitted, since we can add them with kableExtra as well. Also, some variable names are adjusted since we can add categories now (for example "Age: <10 years" is changed to "<10 years", since we can now include a row indicating the category "Age" seperately).


```{r warning=FALSE, message=FALSE}
#Employment growth variable
data_rent$empl_gr <- as.numeric(gsub("%", "",data_rent_100710$empl_gr))     
        #remove % and change into numeric

#Dummy's for stories & age
data_rent$story_high <- ifelse(data_rent$stories>20 & !is.na(data_rent$stories), 1, 0)
data_rent$story_medium <- ifelse(data_rent$stories<21 & data_rent$stories>10 & !is.na(data_rent$stories), 1, 0)
data_rent$story_low <- ifelse(data_rent$stories<11 & !is.na(data_rent$stories), 1, 0)
data_rent$story_low <- ifelse(is.na(data_rent$stories), 1, 0)

data_rent$age_0_10 <- ifelse(data_rent$age < 11 & !is.na(data_rent$age) , 1, 0)
data_rent$age_10_20 <- ifelse(data_rent$age > 10 & data_rent$age < 21 & !is.na(data_rent$age) , 1, 0)
data_rent$age_20_30 <- ifelse(data_rent$age > 20 & data_rent$age < 31 & !is.na(data_rent$age) , 1, 0)
data_rent$age_30_40 <- ifelse(data_rent$age > 30 & data_rent$age < 41 & !is.na(data_rent$age) , 1, 0)
data_rent$age_40 <- ifelse(data_rent$age > 40 & !is.na(data_rent$age) , 1, 0)
data_rent$age_40 <- ifelse(is.na(data_rent$age), 1, 0)

#To deal with NA values, put them in the last category, so no observations get removed because of NA values

#Other changes

data_rent$size_new <- data_rent$size/1000000
  #Size is displayed in millions of square feet: so divide by a million

data_rent$oocc_new <- data_rent$leasing_rate/100
  #fraction occupied: leasing rate in %

data_rent$empl_new <- data_rent$empl_gr/100
  #fraction variable so divided by 100

data_rent$logrent <- log(data_rent$rent)
  #dependent variable is in log


reg1 <- feols(logrent ~ green_rating + size_new + oocc_new + class_a + class_b + net + empl_new| id, data = data_rent)

reg2 <- feols(logrent ~ energystar + leed + size_new + oocc_new + class_a + class_b + net + empl_new| id, data = data_rent)

reg3 <- feols(logrent ~ green_rating + size_new + oocc_new + class_a + class_b + net + empl_new + age_0_10 + age_10_20 + age_20_30 + age_30_40 + renovated | id, data = data_rent)

reg4 <- feols(logrent ~ green_rating + size_new + oocc_new + class_a + class_b + net + empl_new + age_0_10 + age_10_20 + age_20_30 + age_30_40 + renovated + story_medium + story_high + amenities  | id, data = data_rent)
  #regression 1 until 4 include fixed effects for "id"

reg5 <- feols(logrent ~ size_new + oocc_new + class_a + class_b + net + empl_new  + renovated + + age_0_10 + age_10_20 + age_20_30 + age_30_40 + story_medium + story_high + amenities | id + green_rating, data = data_rent)
  #regression 5 includes fixed effects for "id" and "green_rating" variable

models <- list(
  "(1)" = reg1, 
  "(2)" = reg2, 
  "(3)" = reg3, 
  "(4)" = reg4, 
  "(5)" = reg5)


#cm2 & gm2 include the different variable names
cm2 = c('green_rating'    = 'Green rating (1 = yes)',
  'energystar'    = 'Energystar (1 = yes)',
  'leed'    = 'LEED (1 = yes)',
  'size_new'    = 'Building size (millions of sq.ft)',
  'oocc_new' = 'Fraction occupied',
  'class_a' = 'A (1 = yes)',
  'class_b' = 'B (1 = yes)',
  'net' = 'Net contract (1 = yes)',
  'age_0_10' = '<10 years',
  'age_10_20' = '10-20 years',
  'age_20_30' = '20-30 years',
  'age_30_40' = '30-40 years',
  'renovated' = 'Renovated (1 = yes)',
  'story_medium' = 'Intermediate (1 = yes)', 
  'story_high' = 'High (1 = yes)', 
  'amenities' = 'Amenities (1 = yes)')

gm2 <- list(
  list("raw" = "nobs", "clean" = "Sample size", "fmt" = 0),
  list("raw" = "r.squared", "clean" = "R<sup>2</sup>", "fmt" = 2),
  list("raw" = "adj.r.squared", "clean" = "Adjusted R<sup>2</sup>", "fmt" = 2))
      #get_gof(reg1) to see "raw" names of these statistics.
```


```{r}

table1_2 <- msummary(models,
         vcov = "HC1",
         fmt = fmt_statistic(estimate = 3, std.error = 3),
         stars  = c('*' = .1, '**' = 0.05, '***' = .01),
         estimate = "{estimate}",
         statistic = "[{std.error}]{stars}",
         coef_map = cm2, 
         gof_omit = 'AIC|BIC|RMSE|Within|FE',
         gof_map = gm2)
         #without note & title
```

## Themes

The KableExtra package offers one default theme: kable_styling and 6 alternative HTML themes: kable_paper, kable_classic, kable_classic_2, kable_minimal, kable_material & kable_material_dark. 

The only difference between kable_styling and the 6 alternative themes is that the argument to customize the appearance of you table "bootstrap_options" is replaced with "lightable_options". Both options control the styling of the table, but they use different styling frameworks. bootstrap_options provides more options than lightable_options, but depending on what you want they can both be suitable. 

lightable options gives only two choices: "striped" and "hover".
- "striped": rows of the table will be alternately shaded with different colors, which can make it easier to read.
- "hover": when you hover over a row, it will highlight with a different color, which can be helpful for indicating which row you are looking at.

bootstrap_options provides more options:
- "striped"
- "hover"
- "condensed": this option gives slightly lowers the row heights to make the table  smaller. 
- "responsive": this option allows the table to be horizontally scrollable when having the table on a small screen, like a phone. 

## kable_styling formatting options 

```{r}
table1_2%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```


### Full width 

In the kable_styling function, you have the option to specify whether you want the table to have full_width or not. By default, full_width is TRUE for HTML tables. However, for LaTeX tables, the default is FALSE, because the appearance of LaTeX tables is more standardized. 

### Position 

There is also an option in kable_styling to specify the position of the table on the page. The position only matters when the table is not on full_width. The options for position are center/left/right. There is also float-left or float-right if you want to wrap text around the table. 

```{r}
table1_2%>%
  kable_styling(bootstrap_options = c("condensed"),
                full_width = FALSE, 
                position = "center")

```


### Font & font size

```{r}
table1_2%>%
  kable_styling(bootstrap_options = c("condensed"), 
                full_width = FALSE, 
                position = "center",
                font_size = 11,
                html_font = "Times New Roman")

```


## column_spec & row_spec

With column_spec and row_spec you can define specifications for a specific column or row. For example, make them bold, italic or underlined or change the font size.

In the example below, the first column and first row are made bold. (Note that the header row is recognized as row 0).

```{r}

table1_2%>%
  kable_styling(bootstrap_options = c("condensed"), 
                full_width = FALSE, 
                position = "center",
                font_size = 11,
                html_font = "Times New Roman") %>%
  column_spec(1, bold = TRUE) %>%
  row_spec(0, bold = TRUE)


```

## Group rows 

With pack_rows(), we can insert a labelling row. This is perfect for the categories in our variables, namely Building Class, Age and Stories. In the argument pack_rows, you can specify the name of the category and the first and last row of the rows that should be grouped together under this category. 

Energystar and LEED are subgroups of the variable Green rating (row 1). For this, add_intent() is perfect to use. Instead of creating a labelling row, Energystar (row 3) and LEED (row 5) are listed under Green Rating by indenting these subgroups.

```{r}

table1_2%>%
  kable_styling(bootstrap_options = c("condensed"), 
                full_width = FALSE, 
                position = "center",
                font_size = 11,
                html_font = "Times New Roman") %>%
  pack_rows("Building class:", 11, 14, bold=F) %>% 
  pack_rows("Age:", 17,23, bold=F) %>%
  pack_rows("Stories:",27,29, bold=F) %>%
        #bold = F since default gives the name of the category in bold
  add_indent(3) %>%
  add_indent(5)

```



## Footnote

There are 4 notation systems in footnote: general, number, alphabet and symbol. The last three types of footnotes will be labeled with corresponding marks while general won’t be labeled. In this example, we will use the general footnote which has a default title "Note:". This can be changed with "general_title =". In this example, we did not want any default title so we specified general_title = "". 


```{r}
table1_2%>%
  kable_styling(bootstrap_options = c("condensed"), 
                full_width = FALSE, 
                position = "center",
                font_size = 11,
                html_font = "Times New Roman") %>%
  pack_rows("Building class:", 11, 14, bold=F) %>% 
  pack_rows("Age:", 17,23, bold=F) %>%
  pack_rows("Stories:",27,29, bold=F) %>%
  add_indent(3) %>%
  add_indent(5) %>%
   footnote(general_title = "",
  general = "Notes: Each regression also includes 694 dummy variables, one for each locational cluster. 
  Regression (5) also includes an additional 694 dummy variables, one for each green building in 
  the sample. Standard errors are in brackets.
*** Significant at the 1 percent level.
** Significant at the 5 percent level.
* Significant at the 10 percent level. ") 
  
```

## Title / headers 

To add a title to the table, kableExtra provides a "caption = " argument inside the kbl() function. However, the kbl() function is used to create a table object from a data frame or matrix. Since in this case we are customizing a modelsummary regression table, the kbl() function is not  applicable because the regression table is not a data frame or matrix.

Therefore, an alternative method to add a title and subtitle to the regression table is to use the add_header_above function. This function allows you to add a header row above the existing column headers of the regression table. You can specify the name of the header as a character string. In our case, since we want the header to span the entire width of the table, we set the column span to 6.

```{r}
table1_2 %>%
  kable_styling(bootstrap_options = c("condensed"), 
                full_width = FALSE, 
                position = "center",
                font_size = 11,
                html_font = "Times New Roman") %>%
  pack_rows("Building class:", 11, 14, bold=F) %>% 
  pack_rows("Age:", 17,23, bold=F) %>%
  pack_rows("Stories:",27,29, bold=F) %>%
  add_indent(3) %>%
  add_indent(5) %>%
  footnote(general_title = "",
  general = "Notes: Each regression also includes 694 dummy variables, one for each locational cluster. 
  Regression (5) also includes an additional 694 dummy variables, one for each green building in 
  the sample. Standard errors are in brackets.
*** Significant at the 1 percent level.
** Significant at the 5 percent level.
* Significant at the 10 percent level. ") %>%
   add_header_above(c("(dependent variable: logarithm of effective rent in dollars per square foot)" = 6), 
    italic=T, font_size = 11, align = "center") %>%
  add_header_above(c("Table 1—Regression Results, Commercial Office Rents and Green Ratings" = 6), 
    font_size=15, align = "center") 

```

